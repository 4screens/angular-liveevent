!function(e){var t,n=e.module("4screens.liveevent",["LocalStorageModule"]);!function(e){!function(e){e[e.Undefined=0]="Undefined",e[e.Live=1]="Live",e[e.Outcome=2]="Outcome",e[e.Poll=3]="Poll",e[e.Score=4]="Score",e[e.Survey=5]="Survey"}(e.Type||(e.Type={}));e.Type;!function(e){e[e.Undefined=0]="Undefined",e[e.Default=1]="Default",e[e.Preview=2]="Preview",e[e.Result=3]="Result",e[e.Summary=4]="Summary"}(e.Mode||(e.Mode={}));e.Mode}(t||(t={}));var i;!function(e){var n=function(){function e(){this.event=new o.Event}return e.prototype.summaryStatsUnification=function(e){var t={};return t.questionId=e._id,"rateIt"===e.type?(t.avg=e.stats.avg,t):(_.each(e.answers,function(e){t[e._id]=e.percent}),t)},e.prototype.getAnswersForSummary=function(){var e=this,t=a.config.backend.domain+a.config.engageform.presentationViewStats;return t=t.replace(":questionId",this.activePageId),a.$http.get(t).then(function(t){return[200,304].indexOf(t.status)!==-1?e.summaryStatsUnification(t.data):a.$q.reject(t)})},e.prototype.updatePage=function(e){var n=this,i=this.activePage?this.activePage.type+"":null;i&&i.indexOf("form")>-1&&this.currentEngageform.navigation.pick(null,null,{quiet:!0}),this.activePage=e,this.activePageId=e._id,this.currentEngageform.message=null,this.currentEngageform.initPage(e),this.currentEngageform.liveSettings=e.liveSettings,this.currentEngageform.navigation.enabled=!1,this.currentEngageform.navigation.position=0,this.currentEngageform.navigation.size=1,this.currentEngageform.navigation.hasStart=!1,this.currentEngageform.navigation.enabledStart=!1,this.currentEngageform.navigation.hasPrev=!1,this.currentEngageform.navigation.enabledPrev=!1,this.currentEngageform.navigation.hasNext=!1,this.currentEngageform.navigation.enabledNext=!1,this.currentEngageform.navigation.hasFinish=!1,this.currentEngageform.navigation.enabledFinish=!1,this.currentEngageform.navigation.distance=0,this.currentEngageform.navigation.prev=function(e){},this.currentEngageform.navigation.next=function(e,t){},this.currentEngageform.navigation.start=function(e){},this.currentEngageform.navigation.finish=function(e,t){},this.currentEngageform.navigation.truePick||(this.currentEngageform.navigation.truePick=this.currentEngageform.navigation.pick),this.currentEngageform.navigation.pick=function(e,t,i){n.currentEngageform.liveSettings.acceptResponses?n.currentEngageform.navigation.truePick(e,t,i):n.currentEngageform.message="Answering is disabled at the moment."},a.mode===t.Mode.Summary&&this.currentEngageform.current&&this.activePageId&&_.has(a.config,"engageform.presentationViewStats")&&(this.getAnswersForSummary().then(function(e){n.currentEngageform.current.updateAnswers(e)}),this.currentEngageform.liveSettings.showAnswers=!0)},e.prototype.removePage=function(){var e=this;return a.$timeout(function(){e.activePage=null,e.activePageId=null,e.currentEngageform&&(e.currentEngageform.current=null,e.currentEngageform.message=null)})},e.prototype.updateQuiz=function(e){this.currentEngageform=e,this.event.trigger("now::changed",e),this.currentEngageform.navigation.truePick||(this.currentEngageform.navigation.truePick=this.currentEngageform.navigation.pick),this.activeQuiz=this.currentEngageform,this.activeQuizId=this.currentEngageform._engageformId},e.prototype.removeQuiz=function(){var e=this;return this.removePage().then(function(){return a.$timeout(function(){e.activeQuiz=null,e.activeQuizId=null,e.currentEngageform&&(e.currentEngageform.branding=null,e.currentEngageform.current=null,e.currentEngageform.message=null,e.currentEngageform.meta=null,e.currentEngageform.navigation=null,e.currentEngageform.theme=null,e.currentEngageform.title=null,e.currentEngageform.type=null),e.currentEngageform=null})})},e.prototype.initChat=function(e){var t=a.$q.defer();return!this.chat&&e?(this.chat=new r.Chat(e,this),this.chat.init()):(t.resolve(),t.promise)},e.prototype.liveStatusEventHandler=function(e,t){var n=this;e.isActive&&e.activeQuizId?e.activeQuestionId?e.activeQuizId!==this.activeQuizId?this.EF.init({id:e.activeQuizId,mode:"default",live:!0,callback:{sendAnswerCallback:this.sendAnswerCallback},embedSettings:this.embedSettings}).then(function(t){n.updateQuiz(t),n.getPageById(e.activeQuestionId).then(function(e){n.updatePage(e)})}):e.activeQuestionId!==this.activePageId&&this.getPageById(e.activeQuestionId).then(function(e){n.updatePage(e)}):this.removePage():this.removeQuiz(),a.$timeout(function(){n.currentEngageform&&(n.currentEngageform.liveSettings.showAnswers=e.showAnswers,n.currentEngageform.liveSettings.acceptResponses=e.acceptResponses)}),t.callback&&t.callback.liveEventStatus&&(e.id=t.id,t.callback.liveEventStatus(e))},e.prototype.initSocket=function(e){var t=this,n=a.config.backend.socket+a.config.liveEvent.socketNamespace;n=n.replace(":liveEventId",e.id),e.callback=e.callback||{},this.socket=a.io.connect(n,{forceNew:!0}),this.socket.on("liveEventStatus",function(n){t.liveStatusEventHandler(n,e)}),this.socket.on("connect",function(){t.socket.emit("getStatus",{liveEventId:e.id})}),this.socket.on("disconnect",this.initSocket),this.socket.on("error",function(e){console.warn("[ Liveevent:Socket ] Error: "+e)}),this.socket.on("reconnecting",function(){console.warn("[ Liveevent:Socket ] Reconnecting")}),this.socket.on("reconnect_failed",function(){console.warn("[ Liveevent:Socket ] Reconnect failed")}),this.socket.on("reconnect",function(){t.socket.emit("getStatus",{liveEventId:e.id})}),this.socket.on("rateItQuestionStatus",function(e){t.currentEngageform.current.updateAnswers(e)}),this.socket.on("multipleChoiceQuestionAnswers",function(e){t.currentEngageform.current.updateAnswers(e)}),this.socket.on("buzzerQuestionStatus",function(t){e.callback.buzzerQuestionStatus&&(t.id=e.id,e.callback.buzzerQuestionStatus(t))})},e.prototype.getById=function(e){var t=a.config.backend.domain+a.config.liveEvent.liveEventUrl;return t=t.replace(":liveEventId",e),a.$http.get(t).then(function(e){return[200,304].indexOf(e.status)!==-1?e.data:a.$q.reject(e)})},e.prototype.getPageById=function(e){var t=a.config.backend.domain+a.config.liveEvent.activeQuestion;return t=t.replace(":questionId",e),a.$http.get(t).then(function(e){return[200,304].indexOf(e.status)!==-1?e.data:void this.$q.reject(e)})},e.prototype.init=function(e){var t=this,n=a.$q.defer();return this.embedSettings=e.embedSettings,this.id=e.id,this.EF=e.engageform,this.sendAnswerCallback=e.callback.sendAnswerCallback,this.getById(e.id).then(function(i){t.initSocket(e),t.initChat(i.chatId).then(function(){}),n.resolve(t)}),n.promise},e}();e.Liveevent=n}(i||(i={}));var r;!function(e){function t(e,t,n){return this._liveevent.event.trigger("chat::messageFeatureStatusChanged",this._liveevent.id,n,t),n}function n(e,t,n){return n.featured=t,n}var i=function(){function e(e,i){this.messages=[],this.updateMessageHandlers={},this.id=e,this._liveevent=i,this.registerUpdateMessageHandler("featured",n),this.registerUpdateMessageHandler("featured",t)}return e.prototype.registerUpdateMessageHandler=function(e,t){this.updateMessageHandlers[e]||(this.updateMessageHandlers[e]=[]),this.updateMessageHandlers[e].push(t)},e.prototype.login=function(e,t){this.user={accessToken:e.accessToken,user:e.userID,userLink:t.link,userName:t.name,userID:e.userID}},e.prototype.logout=function(){this.user=null},e.prototype.updateChat=function(e){this.id=e.id,this.name=e.name,this.premoderated=e.premoderated,this.direction=e.chatDirection,this.theme=e.theme,this.getMsgs()},e.prototype.sendMsg=function(e,t){if(this.user){var n,i=a.config.backend.domain+a.config.chat.sendUrl;return i=i.replace(":chatId",this.id),n={accessToken:this.user.accessToken,date:Date.now(),hidden:!1,eventId:t,id:this.user.userId,msg:e,user:this.user.user,userLink:this.user.userLink,userName:this.user.userName},a.$http.post(i,n)}},e.prototype.getMsgs=function(e){var t=this,n=a.config.backend.domain+a.config.chat.messagesUrl+"?count=100&eventId="+e;return n=n.replace(":chatId",this.id),a.$http.get(n).then(function(e){t.messages=e.data,t.messages.length&&(t.messages=_.sortBy(t.messages,"date").reverse(),t.direction&&"ttb"===t.direction&&t.messages.reverse()),_.forEach(t.messages,function(e){t._liveevent.event.trigger("chat::message",t._liveevent.id,e)})})},e.prototype.handleNewMessageData=function(e,t){var n=this;return _.forOwn(t,function(t,i){if(t!==e[i]&&_.isArray(n.updateMessageHandlers[i])){var r=e[i];_.forEach(n.updateMessageHandlers[i],function(i){i.call(n,r,t,e)})}}),e},e.prototype.initSocket=function(){var e=this,t=a.config.backend.socket;this.socket=a.io.connect(t,{forceNew:!0}),this.socket.on("error",function(e){console.warn(e)}),this.socket.on("connect",function(t){e.socket.emit("joinRoom",e.id)}),this.socket.on("msg",function(t){var n=_.find(e.messages,function(e){return e.id===t.id});a.$rootScope.$apply(function(){n?e.handleNewMessageData(n,t):e.direction&&"ttb"===e.direction?e.messages.push(t):e.messages.unshift(t)}),n||e._liveevent.event.trigger("chat::message",e._liveevent.id,t)}),this.socket.on("msgHide",function(t){e._liveevent.event.trigger("chat::hideMessage",t);for(var n=e.messages.length,i=0;i<e.messages.length;i+=1)e.messages[i].id===t&&(n=i);a.$rootScope.$apply(function(){e.messages.splice(n,1)})}),this.socket.on("disconnect",this.initSocket)},e.prototype.init=function(){var e=this,t=a.config.backend.domain+a.config.chat.detailUrl;return t=t.replace(":chatId",this.id),a.$http.get(t).then(function(t){return e.updateChat(t.data),e.initSocket(),t})},e}();e.Chat=i}(r||(r={}));var a=function(){function e(t,n,i,r,a,s){e.$http=t,e.$timeout=i,e.$q=n,e.localStorage=r,e.config=s,e.$rootScope=a}return e.prototype.init=function(n){if(e._instances[n.id])return e._instances[n.id];switch(e.io=n.io,n.mode){case"summary":e.mode=t.Mode.Summary;break;case"default":case"":case void 0:e.mode=t.Mode.Default;break;default:return e.$q.reject({status:"error",error:{code:406,message:"Mode property not supported."},data:n})}var r=new i.Liveevent;return n.callback?n.callback.sendAnswerCallback||(n.callback.sendAnswerCallback=function(){}):n.callback={sendAnswerCallback:function(){}},e._instances[n.id]=r.init(n)},e.mode=t.Mode.Undefined,e._instances={},e}();a.$inject=["$http","$q","$timeout","localStorageService","$rootScope","ApiConfig"],n.service("Liveevent",a);var s;!function(e){!function(e){e[e.Undefined=0]="Undefined",e[e.Image=1]="Image",e[e.Input=2]="Input",e[e.Iteration=3]="Iteration",e[e.Text=4]="Text"}(e.CaseType||(e.CaseType={}));e.CaseType;!function(e){e[e.Undefined=0]="Undefined",e[e.EndPage=1]="EndPage",e[e.Form=2]="Form",e[e.MultiChoice=3]="MultiChoice",e[e.PictureChoice=4]="PictureChoice",e[e.Rateit=5]="Rateit",e[e.StartPage=6]="StartPage",e[e.Buzzer=7]="Buzzer",e[e.Poster=8]="Poster"}(e.Type||(e.Type={}));e.Type}(s||(s={}));var s;!function(e){}(s||(s={}));/*!
 * 4screens-angular-liveevent v0.2.0
 * (c) 2015 Nopattern sp. z o.o.
 * License: proprietary
 */
var o;!function(e){var t=function(){function e(){this._listener={}}return e.prototype.listen=function(e,t){this._listener[e]||(this._listener[e]=[]),this._listener[e].push(t)},e.prototype.unsubscribe=function(e,t){this._listener[e]&&(t?_.pull(this._listener[e],t):this._listener[e].length=0)},e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var i=Array.apply(null,arguments).slice(1),r=this._listener[e];if(r)for(var a=0;a<r.length;a++)r[a].apply(null,i)},e}();e.Event=t}(o||(o={}))}(angular);
//# sourceMappingURL=liveevent.min.js.map
