!function(e){/*!
 * 4screens-angular-liveevent v0.1.26
 * (c) 2015 Nopattern sp. z o.o.
 * License: proprietary
 */
var t,n=e.module("4screens.liveevent",["LocalStorageModule"]);!function(e){var t=function(){function e(){console.log("[ Liveevent ] Constructor"),this.event=new r.Event}return e.prototype.updatePage=function(e){var t=this;console.log("[ Liveevent ] Update Page: "+e._id,this.currentEngageform.navigation);var n=this.activePage?this.activePage.type+"":null;n&&n.indexOf("form")>-1&&this.currentEngageform.navigation.pick(null,null,{quiet:!0}),this.activePage=e,this.activePageId=e._id,this.currentEngageform.message=null,this.currentEngageform.initPage(e),this.currentEngageform.liveSettings=e.liveSettings,this.currentEngageform.navigation.enabled=!1,this.currentEngageform.navigation.position=0,this.currentEngageform.navigation.size=1,this.currentEngageform.navigation.hasStart=!1,this.currentEngageform.navigation.enabledStart=!1,this.currentEngageform.navigation.hasPrev=!1,this.currentEngageform.navigation.enabledPrev=!1,this.currentEngageform.navigation.hasNext=!1,this.currentEngageform.navigation.enabledNext=!1,this.currentEngageform.navigation.hasFinish=!1,this.currentEngageform.navigation.enabledFinish=!1,this.currentEngageform.navigation.distance=0,this.currentEngageform.navigation.prev=function(e){},this.currentEngageform.navigation.next=function(e,t){},this.currentEngageform.navigation.start=function(e){},this.currentEngageform.navigation.finish=function(e,t){},this.currentEngageform.navigation.pick=function(e,n,i){t.currentEngageform.liveSettings.acceptResponses?t.currentEngageform.navigation.truePick(e,n,i):t.currentEngageform.message="Answers are currently not accepting"}},e.prototype.removePage=function(){var e=this;console.log("[ Liveevent ] Remove page"),o.$timeout(function(){e.activePage=null,e.activePageId=null,e.currentEngageform&&(e.currentEngageform.current=null,e.currentEngageform.message=null)})},e.prototype.updateQuiz=function(e){this.currentEngageform=e,console.log("[ Liveevent ] Update Quiz: "+this.currentEngageform._engageformId),this.currentEngageform.navigation.truePick=this.currentEngageform.navigation.pick,this.activeQuiz=this.currentEngageform,this.activeQuizId=this.currentEngageform._engageformId},e.prototype.removeQuiz=function(){var e=this;console.log("[ Liveevent ] Remove quiz"),o.$timeout(function(){e.activeQuiz=null,e.activeQuizId=null,e.currentEngageform=null,e.currentEngageform&&(e.currentEngageform.branding=null,e.currentEngageform.current=null,e.currentEngageform.message=null,e.currentEngageform.meta=null,e.currentEngageform.navigation=null,e.currentEngageform.theme=null,e.currentEngageform.title=null,e.currentEngageform.type=null)})},e.prototype.initChat=function(e){var t=o.$q.defer();return!this.chat&&e?(this.chat=new i.Chat(e,this),this.chat.init()):(t.resolve(),t.promise)},e.prototype.initSocket=function(e){var t=this;console.log("[ Liveevent ] Init socket");var n=o.config.backend.socket+o.config.liveEvent.socketNamespace;n=n.replace(":liveEventId",e.id),this.socket=o.io.connect(n,{"force new connection":!0}),this.socket.on("connect",function(){console.log("[ Liveevent:Socket ] Connected"),t.socket.emit("getStatus",{liveEventId:e.id})}),this.socket.on("disconnect",this.initSocket),this.socket.on("error",function(e){console.warn("[ Liveevent:Socket ] Error: "+e)}),this.socket.on("liveEventStatus",function(n){if(!n.isActive)return console.log("[ Liveevent:Socket ] Liveevent is not active"),t.removePage(),t.removeQuiz(),void(e.callback&&e.callback.liveEventStatus&&(n.id=e.id,e.callback.liveEventStatus(n)));if(n.activeQuestionId!==t.activePageId||n.activeQuizId!==t.activeQuizId){if(!n.activeQuizId)return console.log("[ Liveevent ] Quiz is empty"),t.removeQuiz(),void(e.callback&&e.callback.liveEventStatus&&(n.id=e.id,e.callback.liveEventStatus(n)));if(t.EF.init({id:n.activeQuizId,mode:"default"}).then(function(e){t.currentEngageform=e}),!n.activeQuestionId)return console.log("[ Liveevent ] Page is empty"),t.removePage(),void(e.callback&&e.callback.liveEventStatus&&(n.id=e.id,e.callback.liveEventStatus(n)));n.activeQuizId!==t.activeQuizId?(console.log("[ Liveevent:Socket ] Quiz changed"),t.EF.init({id:n.activeQuizId,mode:"default"}).then(function(e){t.updateQuiz(e),t.getPageById(n.activeQuestionId).then(function(e){t.updatePage(e)})})):(console.log("[ Liveevent:Socket ] Only Page changed"),t.getPageById(n.activeQuestionId).then(function(e){t.updatePage(e)}))}t.currentEngageform&&(n.showAnswers!==t.currentEngageform.liveSettings.showAnswers&&(console.log("[ Liveevent ] Show answer option changed"),o.$timeout(function(){t.currentEngageform.liveSettings.showAnswers=n.showAnswers})),n.acceptResponses!==t.currentEngageform.liveSettings.acceptResponses&&(console.log("[ Liveevent ] Accept responses option changed"),o.$timeout(function(){t.currentEngageform.liveSettings.acceptResponses=n.acceptResponses,t.currentEngageform.message=""}))),e.callback&&e.callback.liveEventStatus&&(n.id=e.id,e.callback.liveEventStatus(n))}),this.socket.on("multipleChoiceQuestionAnswers",function(e){t.currentEngageform.current.updateAnswers(e)}),this.socket.on("buzzerQuestionStatus",function(t){e.callback&&e.callback.buzzerQuestionStatus&&(t.id=e.id,e.callback.buzzerQuestionStatus(t))})},e.prototype.getById=function(e){var t=o.config.backend.domain+o.config.liveEvent.liveEventUrl;return t=t.replace(":liveEventId",e),o.$http.get(t).then(function(e){return-1!==[200,304].indexOf(e.status)?e.data:o.$q.reject(e)})},e.prototype.getPageById=function(e){var t=o.config.backend.domain+o.config.liveEvent.activeQuestion;return t=t.replace(":questionId",e),o.$http.get(t).then(function(e){return-1!==[200,304].indexOf(e.status)?(console.log("[ Liveevent ] Get PAGE: "+e.data._id),e.data):void this.$q.reject(e)})},e.prototype.init=function(e){var t=this;console.log("[ Liveevent ] Init: "+e.id);var n=o.$q.defer();return this.id=e.id,this.EF=e.engageform,this.getById(e.id).then(function(i){t.initSocket(e),t.initChat(i.chatId).then(function(){}),n.resolve(t)}),n.promise},e}();e.Liveevent=t}(t||(t={}));var i;!function(e){var t=function(){function e(e,t){this.messages=[],console.log("[ Chat ] Constructor"),this.id=e,this._liveevent=t}return e.prototype.login=function(e,t){this.user={accessToken:e.accessToken,user:e.userID,userLink:t.link,userName:t.name,userID:e.userID}},e.prototype.logout=function(){this.user=null},e.prototype.updateChat=function(e){console.log("[ Chat ] Update chat"),this.id=e.id,this.name=e.name,this.premoderated=e.premoderated,this.direction=e.chatDirection,this.theme=e.theme,this.getMsgs()},e.prototype.sendMsg=function(e){if(console.log("[ Chat ] Posting msg"),this.user){var t,n=o.config.backend.domain+o.config.chat.sendUrl;return n=n.replace(":chatId",this.id),t={accessToken:this.user.accessToken,date:Date.now(),hidden:!1,id:this.user.userId,msg:e,user:this.user.user,userLink:this.user.userLink,userName:this.user.userName},o.$http.post(n,t)}},e.prototype.getMsgs=function(){var e=this;console.log("[ Chat ] Get old msgs");var t=o.config.backend.domain+o.config.chat.messagesUrl;return t=t.replace(":chatId",this.id),o.$http.get(t).then(function(t){e.messages=t.data,e.messages.length&&(e.messages=_.sortBy(e.messages,"date").reverse(),e.direction&&"ttb"===e.direction&&e.messages.reverse())})},e.prototype.initSocket=function(){var e=this;console.log("[ Chat:Socket ] Init socket");var t=o.config.backend.socket;this.socket=o.io.connect(t,{"force new connection":!0}),this.socket.on("error",function(e){console.warn(e)}),this.socket.on("connect",function(t){console.log("[ Chat:Socket ] Connected"),e.socket.emit("joinRoom",e.id)}),this.socket.on("msg",function(t){console.log("[ Chat:Socket ] New msg"),e._liveevent.event.trigger("chat::message",e._liveevent.id,t),o.$rootScope.$apply(function(){e.direction&&"ttb"===e.direction?e.messages.push(t):e.messages.unshift(t)})}),this.socket.on("msgHide",function(t){console.log("[ Chat:Socket] Hide msg");for(var n=e.messages.length,i=0;i<e.messages.length;i+=1)e.messages[i].id===t&&(n=i);o.$rootScope.$apply(function(){e.messages.splice(n,1)})}),this.socket.on("disconnect",this.initSocket)},e.prototype.init=function(){var e=this;console.log("[ Chat ] Init: "+this.id);var t=o.config.backend.domain+o.config.chat.detailUrl;return t=t.replace(":chatId",this.id),o.$http.get(t).then(function(t){return e.updateChat(t.data),e.initSocket(),t})},e}();e.Chat=t}(i||(i={}));var o=function(){function e(t,n,i,o,r,a){e.$http=t,e.$timeout=i,e.$q=n,e.localStorage=o,e.config=a,e.$rootScope=r}return e.prototype.init=function(n){if(e._instances[n.id])return e._instances[n.id];e.io=n.io;var i=new t.Liveevent;return e._instances[n.id]=i.init(n)},e._instances={},e}();o.$inject=["$http","$q","$timeout","localStorageService","$rootScope","ApiConfig"],n.service("Liveevent",o);var r;!function(e){var t=function(){function e(){this._listener={}}return e.prototype.listen=function(e,t){console.log("[ Util:Event ] listen",e),this._listener[e]||(this._listener[e]=[]),this._listener[e].push({next:t})},e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];console.log("[ Util:Event ] trigger",e);var i=Array.apply(null,arguments).slice(1),o=this._listener[e];if(o)for(var r=0;r<o.length;r++)o[r].next.apply(null,i)},e}();e.Event=t}(r||(r={}))}(angular);
//# sourceMappingURL=liveevent.min.js.map